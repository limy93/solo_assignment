from behave import given, when, then
from django.contrib.auth.models import User
from django.urls import reverse
from selenium import webdriver

@given('I am logged in')
def step_impl(context):
    # Register the user if not already registered
    if not User.objects.filter(username='testuser').exists():
        User.objects.create_user(username='testuser', password='complexpassword123')

    # Proceed with logging in
    context.browser = webdriver.Chrome()
    context.browser.get(context.get_url(reverse('login')))
    context.browser.find_element_by_name('username').send_keys('testuser')
    context.browser.find_element_by_name('password').send_keys('complexpassword123')
    context.browser.find_element_by_css_selector('form').submit()

@when('I add a product to my cart')
def step_impl(context):
    context.browser.find_element_by_name('add_to_cart').click()

@then('The product should be in my cart')
def step_impl(context):
    context.browser.get(context.get_url(reverse('cart_detail')))
    assert '1 x' in context.browser.page_source
    context.browser.quit()

# Clean up the test user after the test completes
def after_scenario(context, scenario):
    if User.objects.filter(username='testuser').exists():
        User.objects.get(username='testuser').delete()